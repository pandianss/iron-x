generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  user_id                  String   @id @default(uuid())
  email                    String   @unique
  password_hash            String
  timezone                 String
  current_discipline_score Int      @default(0)
  created_at               DateTime @default(now())

  teams_owned       Team[]
  team_memberships  TeamMember[]
  goals             Goal[]
  actions           Action[]
  action_instances  ActionInstance[]
  discipline_scores DisciplineScore[]
  subscription      Subscription?

  // Phase 3: Enforcement & Enterprise Fields
  enforcement_mode        String    @default("NONE") // 'NONE', 'SOFT', 'HARD'
  locked_until            DateTime?
  acknowledgment_required Boolean   @default(false)

  // Phase 3.5: Experience Hardening
  discipline_classification   String   @default("UNRELIABLE") // 'UNRELIABLE', 'RECOVERING', 'STABLE', 'HIGH_RELIABILITY'
  classification_last_updated DateTime @default(now())

  audit_logs_actor  AuditLog[] @relation("AuditLogActor")
  audit_logs_target AuditLog[] @relation("AuditLogTarget")

  outcomes Outcome[]

  // Phase 6: Role & Policy
  role_id    String?
  role       Role?                 @relation(fields: [role_id], references: [role_id])
  exceptions DisciplineException[]

  // MFA Fields
  mfa_enabled Boolean @default(false)
  mfa_secret  String?

  org_id       String?
  organization Organization? @relation("OrgUsers", fields: [org_id], references: [org_id])

  @@map("users")
}

model Team {
  team_id    String   @id @default(uuid())
  name       String
  owner_id   String?
  created_at DateTime @default(now())

  owner   User?        @relation(fields: [owner_id], references: [user_id])
  members TeamMember[]

  org_id       String?
  organization Organization? @relation(fields: [org_id], references: [org_id])

  // Phase 3: Enterprise Policy
  max_seats          Int     @default(5)
  enforcement_policy String? // JSON or Config ID
  sso_config_id      String? @unique

  sso_config SSOConfig? @relation(fields: [sso_config_id], references: [config_id])
  outcomes   Outcome[]

  @@map("teams")
  invitations TeamInvitation[]
}

model Organization {
  org_id     String   @id @default(uuid())
  name       String
  slug       String   @unique
  created_at DateTime @default(now())

  teams    Team[]
  users    User[]          @relation("OrgUsers")
  policies OrgPolicy[]
  subscription Subscription?

  webhooks Webhook[]
  api_keys ApiKey[]

  @@map("organizations")
}

model Webhook {
  webhook_id String   @id @default(uuid())
  org_id     String
  url        String
  secret     String?  // For signing payloads
  events     String   // Comma-separated list of events: 'violation.locked', 'goal.completed'
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())

  organization Organization @relation(fields: [org_id], references: [org_id])

  @@map("webhooks")
}

model ApiKey {
  key_id     String    @id @default(uuid())
  org_id     String
  name       String
  key_hash   String    @unique
  last_used  DateTime?
  expires_at DateTime?
  created_at DateTime  @default(now())

  organization Organization @relation(fields: [org_id], references: [org_id])

  @@map("api_keys")
}

model OrgPolicy {
  policy_id   String   @id @default(uuid())
  org_id      String
  organization Organization @relation(fields: [org_id], references: [org_id])

  rule_name   String   // e.g., 'MIN_DISCIPLINE_SCORE'
  rule_value  String
  is_mandatory Boolean @default(false)

  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@map("org_policies")
}

model TeamInvitation {
  invitation_id String   @id @default(uuid())
  team_id       String
  email         String
  token         String   @unique
  status        String   @default("PENDING") // 'PENDING', 'ACCEPTED', 'DECLINED'
  role          String   @default("MEMBER")
  expires_at    DateTime
  created_at    DateTime @default(now())

  team Team @relation(fields: [team_id], references: [team_id])

  @@map("team_invitations")
}

model SSOConfig {
  config_id        String   @id @default(uuid())
  entry_point      String // IDP SSO URL
  issuer           String // IDP Entity ID
  cert             String // Public cert for signature validation
  domain_whitelist String // Comma separated domains
  enabled          Boolean  @default(false)
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  team Team?

  @@map("sso_configs")
}

// ... (existing models)

model TeamMember {
  team_member_id String   @id @default(uuid())
  team_id        String
  user_id        String
  role           String // 'MEMBER', 'MANAGER'
  joined_at      DateTime @default(now())

  team Team @relation(fields: [team_id], references: [team_id])
  user User @relation(fields: [user_id], references: [user_id])

  @@unique([team_id, user_id])
  @@map("team_members")
}

model Goal {
  goal_id     String    @id @default(uuid())
  user_id     String?
  title       String
  description String?
  deadline    DateTime?
  status      String    @default("ACTIVE")
  created_at  DateTime  @default(now())

  user    User?    @relation(fields: [user_id], references: [user_id])
  actions Action[]

  @@map("goals")
}

model Action {
  action_id               String   @id @default(uuid())
  user_id                 String?
  goal_id                 String?
  title                   String
  description             String?
  frequency_rule          String
  window_start_time       DateTime
  window_duration_minutes Int
  is_strict               Boolean  @default(true)
  created_at              DateTime @default(now())

  user User? @relation(fields: [user_id], references: [user_id])
  goal Goal? @relation(fields: [goal_id], references: [goal_id])

  intentions  ImplementationIntention[]
  instances   ActionInstance[]
  habit_state HabitState?

  @@map("actions")
}

model ImplementationIntention {
  intention_id      String   @id @default(uuid())
  action_id         String?
  trigger_condition String
  response_action   String
  created_at        DateTime @default(now())

  action Action? @relation(fields: [action_id], references: [action_id])

  @@map("implementation_intentions")
}

model ActionInstance {
  instance_id          String    @id @default(uuid())
  action_id            String?
  user_id              String?
  scheduled_date       DateTime
  scheduled_start_time DateTime
  scheduled_end_time   DateTime
  executed_at          DateTime?
  status               String? // 'PENDING', 'COMPLETED', 'MISSED', 'LATE'
  created_at           DateTime  @default(now())

  action  Action?  @relation(fields: [action_id], references: [action_id])
  user    User?    @relation(fields: [user_id], references: [user_id])
  prompts Prompt[]

  linked_outcomes OutcomeActionLink[]

  @@map("action_instances")
}

model Prompt {
  prompt_id       String    @id @default(uuid())
  instance_id     String?
  sent_at         DateTime  @default(now())
  acknowledged_at DateTime?
  type            String? // 'PUSH', 'EMAIL'

  instance ActionInstance? @relation(fields: [instance_id], references: [instance_id])

  @@map("prompts")
}

model DisciplineScore {
  score_id       String   @id @default(uuid())
  user_id        String?
  date           DateTime
  score          Int
  execution_rate Decimal?
  on_time_rate   Decimal?
  calculated_at  DateTime @default(now())

  user User? @relation(fields: [user_id], references: [user_id])

  @@unique([user_id, date])
  @@map("discipline_scores")
}

model HabitState {
  habit_id             String    @id @default(uuid())
  action_id            String?   @unique
  current_streak       Int?      @default(0)
  habit_strength_score Int?      @default(0)
  last_executed_at     DateTime?
  updated_at           DateTime  @default(now())

  action Action? @relation(fields: [action_id], references: [action_id])

  @@map("habit_states")
}

// Phase 3: System Reliability & Governance
model AuditLog {
  log_id         String   @id @default(uuid())
  actor_id       String?
  target_user_id String?
  action         String
  details        String? // JSON string
  timestamp      DateTime @default(now())

  actor  User? @relation("AuditLogActor", fields: [actor_id], references: [user_id])
  target User? @relation("AuditLogTarget", fields: [target_user_id], references: [user_id])

  @@map("audit_logs")
}

model SystemConfig {
  config_key       String           @id
  value            String
  updated_at       DateTime         @updatedAt
  control_mappings ControlMapping[]

  @@map("system_configs")
}

// Phase 4: Commercial Hardening
enum SubscriptionTier {
  FREE
  INDIVIDUAL_PRO
  TEAM_ENTERPRISE
}

model Subscription {
  subscription_id String           @id @default(uuid())
  user_id         String?          @unique
  org_id          String?          @unique
  plan_tier       SubscriptionTier @default(FREE)
  start_date      DateTime         @default(now())
  end_date        DateTime?
  is_active       Boolean          @default(true)
  stripe_customer_id String?       @unique
  stripe_subscription_id String?   @unique
  metadata        String? // JSON for payment/cust_id
  created_at      DateTime         @default(now())
  updated_at      DateTime         @updatedAt

  user         User?         @relation(fields: [user_id], references: [user_id])
  organization Organization? @relation(fields: [org_id], references: [org_id])

  @@map("subscriptions")
}

// Phase 5: Outcome Modeling

model Outcome {
  outcome_id       String    @id @default(uuid())
  user_id          String?
  team_id          String?
  title            String
  description      String?
  type             String // 'PRODUCTIVITY', 'COMPLIANCE', 'RELIABILITY', 'CUSTOM'
  source           String // 'SYSTEM_DERIVED', 'EXTERNAL_INPUT'
  value            String // Stored as string, parsed based on logic
  confidence_score Float?    @default(0.0) // 0.0 - 1.0
  calculated_at    DateTime  @default(now())
  valid_from       DateTime
  valid_until      DateTime?

  user User? @relation(fields: [user_id], references: [user_id])
  team Team? @relation(fields: [team_id], references: [team_id])

  linked_actions OutcomeActionLink[]

  @@map("outcomes")
}

model OutcomeActionLink {
  link_id     String @id @default(uuid())
  outcome_id  String
  instance_id String

  outcome  Outcome        @relation(fields: [outcome_id], references: [outcome_id])
  instance ActionInstance @relation(fields: [instance_id], references: [instance_id])

  @@unique([outcome_id, instance_id])
  @@map("outcome_action_links")
}

model OutcomeRule {
  rule_id        String  @id @default(uuid())
  owner_id       String? // User or Team ID
  name           String
  description    String?
  condition_json String // Logic: e.g. "discipline_score > 90 for 7 days"
  target_type    String // OutcomeType
  target_val_tpl String // "High Reliability" or "99.9%"

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("outcome_rules")
}

// Phase 6: Institutionalization & Policy Embedding

model Policy {
  policy_id   String  @id @default(uuid())
  name        String
  description String?
  scope       String // 'ORG', 'DEPARTMENT', 'TEAM', 'ROLE', 'USER'

  // JSON rules: thresholds, lockout_duration, etc.
  // Example: { "max_misses": 3, "score_threshold": 50, "lockout_hours": 24 }
  rules String

  enforcement_mode String @default("SOFT") // 'NONE', 'SOFT', 'HARD'

  parent_policy_id String?
  parent_policy    Policy?  @relation("PolicyHierarchy", fields: [parent_policy_id], references: [policy_id])
  child_policies   Policy[] @relation("PolicyHierarchy")

  effective_from  DateTime  @default(now())
  effective_until DateTime?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  roles            Role[]
  exceptions       DisciplineException[]
  control_mappings ControlMapping[]

  @@map("policies")
}

model Role {
  role_id     String  @id @default(uuid())
  name        String  @unique // e.g., 'Analyst', 'Manager', 'Executive'
  description String?
  policy_id   String?

  policy Policy? @relation(fields: [policy_id], references: [policy_id])
  users  User[]

  @@map("roles")
}

model DisciplineException {
  exception_id String    @id @default(uuid())
  user_id      String
  policy_id    String?
  reason       String
  approved_by  String? // User ID of approver
  valid_from   DateTime  @default(now())
  valid_until  DateTime?

  user   User    @relation(fields: [user_id], references: [user_id])
  policy Policy? @relation(fields: [policy_id], references: [policy_id])

  @@map("discipline_exceptions")
}

// Phase 7: Regulatory Compliance
model Control {
  control_id   String @id @default(uuid())
  framework    String // 'ISO 27001', 'SOC 2', 'GDPR'
  control_code String // 'A.12.6.1', 'CC6.1'
  description  String

  mappings ControlMapping[]

  @@unique([framework, control_code])
  @@map("controls")
}

model ControlMapping {
  mapping_id String @id @default(uuid())
  control_id String

  // Link to internal entities
  policy_id         String?
  system_config_key String?

  // Narrative description of how it is met
  enforcement_mechanism String // 'POLICY_RESTRICTION', 'IMMUTABLE_LOG', 'ACCESS_CONTROL'
  evidence_source       String // 'DB_TABLE:policies', 'LOG:audit_logs'

  control       Control       @relation(fields: [control_id], references: [control_id])
  policy        Policy?       @relation(fields: [policy_id], references: [policy_id])
  system_config SystemConfig? @relation(fields: [system_config_key], references: [config_key])

  @@map("control_mappings")
}
